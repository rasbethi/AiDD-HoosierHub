{% extends 'base.html' %}
{% block title %}Booking Details{% endblock %}
{% block content %}

<section class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="fw-bold text-danger mb-1"><i class="fas fa-file-alt me-2"></i>Booking Details</h1>
      <p class="text-muted mb-0">A closer look at this reservation.</p>
    </div>
    <a href="{{ url_for('admin.manage_bookings') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Back to All Bookings
    </a>
  </div>

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <h2 class="h4 mb-3">{{ booking.resource.title }}</h2>
          <p class="text-muted mb-2">
            <i class="fas fa-map-marker-alt me-2 text-danger"></i>{{ booking.resource.location }}
          </p>
          <p class="text-muted">
            <strong>Category:</strong> {{ booking.resource.category or "General" }}<br>
            <strong>Access:</strong> {{ booking.resource.access_type|capitalize }}
          </p>

          <hr>

          <h3 class="h6 text-uppercase text-muted">Booking Window</h3>
          <p class="mb-2">
            <i class="fas fa-calendar me-2 text-danger"></i>
            {{ booking.start_time.strftime('%b %d, %Y %I:%M %p') }} <br>
            <i class="fas fa-arrow-down me-2 text-danger"></i>
            {{ booking.end_time.strftime('%b %d, %Y %I:%M %p') }}
          </p>

          <h3 class="h6 text-uppercase text-muted">Purpose</h3>
          <p class="mb-0">{{ booking.purpose or "â€”" }}</p>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
          <h3 class="h6 text-uppercase text-muted">Booked For</h3>
          <p class="mb-1 fw-semibold">{{ booking.user.name }}</p>
          <p class="text-muted mb-3">{{ booking.user.email }}</p>
          <span class="badge bg-primary">{{ booking.user.role|capitalize }}</span>
        </div>
      </div>

      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
          <h3 class="h6 text-uppercase text-muted">Status</h3>
          <span class="badge
            {% if booking.status|lower == 'approved' %}
              bg-success
            {% elif booking.status|lower == 'pending' %}
              bg-warning text-dark
            {% else %}
              bg-secondary
            {% endif %}
          ">
            {{ booking.status|capitalize }}
          </span>

          {% if booking.approver %}
          <p class="mt-3 mb-0 text-muted">
            Approved by {{ booking.approver.name }} ({{ booking.approver.email }})
          </p>
          {% endif %}

          {% if booking.rejection_reason %}
          <p class="mt-3 mb-0 text-muted">
            Rejection Reason: {{ booking.rejection_reason }}
          </p>
          {% endif %}
        </div>
      </div>

      <div id="manage" class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
          <h3 class="h6 text-uppercase text-muted">Manage Booking</h3>
          <p class="text-muted small mb-3">Update the status or cancel on behalf of the user. Notifications are sent automatically.</p>

          {% if booking.status == 'pending' %}
          <form method="POST" action="{{ url_for('admin.approve_booking', booking_id=booking.id) }}" class="mb-3">
            <button type="submit" class="btn btn-success w-100">
              <i class="fas fa-check me-2"></i>Approve Booking
            </button>
          </form>
          {% endif %}

          {% if booking.status not in ['rejected', 'cancelled'] %}
          <form method="POST" action="{{ url_for('admin.cancel_booking', booking_id=booking.id) }}">
            <div class="mb-3">
              <label class="form-label">Cancellation Reason</label>
              <textarea name="reason" class="form-control" rows="3" placeholder="Let the user know why this booking was cancelled.">Cancelled by admin per user request.</textarea>
            </div>
            <button type="submit" class="btn btn-outline-danger w-100">
              <i class="fas fa-ban me-2"></i>Cancel Booking & Notify User
            </button>
          </form>
          {% else %}
          <div class="alert alert-secondary mb-0">
            This booking has already been cancelled.
          </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</section>

{% endblock %}

